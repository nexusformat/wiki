


<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>NXlrcs.f90</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="_static/sphinxdoc.css?v=34905f61" />
    <link rel="stylesheet" type="text/css" href="_static/details_summary_hide.css?v=30df4bca" />
    <link rel="stylesheet" href="_static/blockquote.css" type="text/css" />
    <link rel="stylesheet" href="_static/rubric.css" type="text/css" />
    <script src="_static/documentation_options.js?v=b08bce9f"></script>
    <script src="_static/doctools.js?v=fd6eb6e6"></script>
    <script src="_static/sphinx_highlight.js?v=6ffebe34"></script>
    <link rel="icon" href="https://raw.githubusercontent.com/nexusformat/NIAC/master/NeXus_Logo/NeXus_Logo_dark_square.svg"/>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="NXmeasurement" href="NXmeasurement.html" />
    <link rel="prev" title="NXgeometry and NXshape - documentation and review" href="NXgeometry_and_NXshape_-_documentation_and_review.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="NXmeasurement.html" title="NXmeasurement"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="NXgeometry_and_NXshape_-_documentation_and_review.html" title="NXgeometry and NXshape - documentation and review"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html"></a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">NXlrcs.f90</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="nxlrcs-f90">
<h1>NXlrcs.f90<a class="headerlink" href="#nxlrcs-f90" title="Link to this heading">Â¶</a></h1>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="k">program </span><span class="n">NXlrcs</span>

<span class="w">       </span><span class="k">use </span><span class="n">IPNS_module</span>
<span class="w">       </span><span class="k">use </span><span class="n">NXUmodule</span>

<span class="w">       </span><span class="k">type</span><span class="p">(</span><span class="n">IPNS_histogram</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">hist</span>
<span class="w">       </span><span class="k">type</span><span class="p">(</span><span class="n">IPNS_sgarray</span><span class="p">)</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">sgarray</span>
<span class="w">       </span><span class="k">type</span><span class="p">(</span><span class="n">IPNS_subgroup</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">sg</span>
<span class="w">       </span><span class="k">type</span><span class="p">(</span><span class="n">IPNS_timefield</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tf</span>
<span class="w">       </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">sglist</span>
<span class="w">       </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">int_value</span>
<span class="w">       </span><span class="kt">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">real_value</span>
<span class="w">       </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">char_value</span><span class="p">,</span><span class="w"> </span><span class="k">entry</span>
<span class="k">       </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">argv</span>
<span class="w">       </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">run_no</span>
<span class="w">       </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">iso_time</span>
<span class="w">       </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">IPNS_time</span>
<span class="w">       </span><span class="kt">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">L1</span>
<span class="w">       </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">char_size</span><span class="p">,</span><span class="w"> </span><span class="n">Nhist</span><span class="p">,</span><span class="w"> </span><span class="n">Nsg</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">status</span>
<span class="w">       </span><span class="k">type</span><span class="p">(</span><span class="n">NXhandle</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">file_id</span>
<span class="w">       </span><span class="k">type</span><span class="p">(</span><span class="n">NXlink</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">phi_id</span><span class="p">,</span><span class="w"> </span><span class="n">time_id</span><span class="p">,</span><span class="w"> </span><span class="n">M1_id</span><span class="p">,</span><span class="w"> </span><span class="n">M2_id</span>

<span class="w">       </span><span class="c">!Open LRMECS run file</span>
<span class="w">       </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">IARGC</span><span class="p">()</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          write</span><span class="w"> </span><span class="p">(</span><span class="n">unit</span><span class="o">=*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;(a)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">advance</span><span class="o">=</span><span class="s2">&quot;no&quot;</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot; Give run number : &quot;</span>
<span class="w">          </span><span class="k">read</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">int_value</span>
<span class="w">       </span><span class="k">else</span>
<span class="k">          call </span><span class="nb">GETARG</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span>
<span class="w">          </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">argv</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;(i10)&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">int_value</span>
<span class="w">       </span><span class="k">end if</span>
<span class="k">       write</span><span class="w"> </span><span class="p">(</span><span class="n">run_no</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;(i4.4)&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">int_value</span>
<span class="w">       </span><span class="k">call </span><span class="n">open_IPNS_file</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;/data/lrmecs/lrcs&quot;</span><span class="o">//</span><span class="n">run_no</span><span class="o">//</span><span class="s2">&quot;.run&quot;</span><span class="p">)</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">IPNS_OK</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">IPNS_message</span>
<span class="w">          </span><span class="k">stop</span>
<span class="k">       end if</span>
<span class="w">    </span><span class="c">!Open NeXus output file and write global attributes</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXopen</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;lrcs&quot;</span><span class="o">//</span><span class="n">run_no</span><span class="o">//</span><span class="s2">&quot;.nxs&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">NXACC_CREATE</span><span class="p">,</span><span class="w"> </span><span class="n">file_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">       call </span><span class="n">get_IPNS_item</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;NAM&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">char_value</span><span class="p">,</span><span class="w"> </span><span class="n">item_size</span><span class="o">=</span><span class="n">char_size</span><span class="p">)</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwriteglobals</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">char_value</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">char_size</span><span class="p">)))</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">       call </span><span class="n">get_IPNS_item</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;NHT&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nhist</span><span class="p">)</span>
<span class="w">    </span><span class="c">!Set default compression algorithm for larger data sets</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUsetcompress</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="n">NX_COMP_LZW</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="w">    </span><span class="c">!Loop over each run-file histogram</span>
<span class="w">       </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">Nhist</span>
<span class="w">    </span><span class="c">!Open one NXentry for each histogram</span>
<span class="w">          </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="k">entry</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;(a,i1)&quot;</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;Histogram&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="k">entry</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;NXentry&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">             call </span><span class="n">get_IPNS_item</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;TTL&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">char_value</span><span class="p">)</span>
<span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;title&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">char_value</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">             if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;analysis&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;TOFNDGS&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">             call </span><span class="n">get_IPNS_item</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;SDT&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">char_value</span><span class="p">)</span>
<span class="w">             </span><span class="n">IPNS_time</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">char_value</span><span class="o">//</span><span class="s2">&quot; &quot;</span>
<span class="w">             </span><span class="k">call </span><span class="n">get_IPNS_item</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;STM&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">char_value</span><span class="p">)</span>
<span class="w">             </span><span class="n">IPNS_time</span><span class="p">(</span><span class="mi">11</span><span class="p">:</span><span class="mi">18</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">char_value</span>
<span class="w">             </span><span class="k">call </span><span class="n">convert_time</span><span class="w"> </span><span class="p">(</span><span class="n">IPNS_time</span><span class="p">,</span><span class="w"> </span><span class="n">iso_time</span><span class="p">)</span>
<span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;start_time&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">iso_time</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">             call </span><span class="n">get_IPNS_item</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;EDT&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">char_value</span><span class="p">)</span>
<span class="w">             </span><span class="n">IPNS_time</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">char_value</span><span class="o">//</span><span class="s2">&quot; &quot;</span>
<span class="w">             </span><span class="k">call </span><span class="n">get_IPNS_item</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;ETM&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">char_value</span><span class="p">)</span>
<span class="w">             </span><span class="n">IPNS_time</span><span class="p">(</span><span class="mi">11</span><span class="p">:</span><span class="mi">18</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">char_value</span>
<span class="w">             </span><span class="k">call </span><span class="n">convert_time</span><span class="w"> </span><span class="p">(</span><span class="n">IPNS_time</span><span class="p">,</span><span class="w"> </span><span class="n">iso_time</span><span class="p">)</span>
<span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;end_time&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">iso_time</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">             call </span><span class="n">get_IPNS_item</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;RUN&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">int_value</span><span class="p">)</span>
<span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;run_number&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">int_value</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="w">       </span><span class="c">!Open NXsample</span>
<span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;sample&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;NXsample&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                call </span><span class="n">get_IPNS_item</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;L1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">L1</span><span class="p">)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;distance&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;moderator_distance&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">L1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">             if</span><span class="w"> </span><span class="p">(</span><span class="n">NXclosegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="w">       </span><span class="c">!Open NXinstrument</span>
<span class="w">             </span><span class="k">call </span><span class="n">get_IPNS_item</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">hist</span><span class="p">)</span>
<span class="w">             </span><span class="n">Nsg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">hist</span><span class="p">%</span><span class="n">sg</span><span class="p">)</span>
<span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                allocate</span><span class="w"> </span><span class="p">(</span><span class="n">sglist</span><span class="p">(</span><span class="n">nsg</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
<span class="w">                </span><span class="n">sglist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">Nsg</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="p">)</span>
<span class="w">             </span><span class="k">else</span>
<span class="k">                allocate</span><span class="w"> </span><span class="p">(</span><span class="n">sglist</span><span class="p">(</span><span class="n">Nsg</span><span class="p">))</span>
<span class="w">                </span><span class="n">sglist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nsg</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="p">)</span>
<span class="w">             </span><span class="k">end if</span>
<span class="k">             call </span><span class="n">get_IPNS_item</span><span class="w"> </span><span class="p">(</span><span class="n">sglist</span><span class="p">,</span><span class="w"> </span><span class="n">sgarray</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)</span>
<span class="w">             </span><span class="k">deallocate</span><span class="w"> </span><span class="p">(</span><span class="n">sglist</span><span class="p">)</span>
<span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;LRMECS&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;NXinstrument&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="w">          </span><span class="c">!Open NXsource</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;source&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;NXsource&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;distance&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">L1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   call </span><span class="n">get_IPNS_item</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;PLS&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">int_value</span><span class="p">)</span>
<span class="w">                   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;proton_pulses&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">int_value</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;IPNS&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;type&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Spallation Neutron Source&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;frequency&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Hz&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;target_material&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;depleted_U&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;moderator&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;CH4&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">NXclosegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="w">          </span><span class="c">!Open NXchopper</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;monochromator&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;NXchopper&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   call </span><span class="n">get_IPNS_item</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;LCH&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">real_value</span><span class="p">)</span>
<span class="w">                   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;distance&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">real_value</span><span class="o">-</span><span class="n">L1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;moderator_distance&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">real_value</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;type&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Fermi&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   call </span><span class="n">get_IPNS_item</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;EIN&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">real_value</span><span class="p">)</span>
<span class="w">                   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;energy&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">real_value</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;meV&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                      if</span><span class="w"> </span><span class="p">(</span><span class="n">NXputattr</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;calibration_status&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Nominal&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">NXclosegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="w">          </span><span class="c">!Open NXdetector</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;detector_bank&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;NXdetector&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;distance&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sgarray</span><span class="p">%</span><span class="n">L2</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;type&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;He3 gas cylinder&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gas_pressure&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">6.0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;bars&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;time_of_flight&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sgarray</span><span class="p">%</span><span class="n">time_of_flight</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;microseconds&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                      if</span><span class="w"> </span><span class="p">(</span><span class="n">NXgetdataID</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="n">time_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                      if</span><span class="w"> </span><span class="p">(</span><span class="n">NXputattr</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;long_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Time-of-Flight [microseconds]&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;polar_angle&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sgarray</span><span class="p">%</span><span class="n">phi</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;degrees&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                      if</span><span class="w"> </span><span class="p">(</span><span class="n">NXgetdataID</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="n">phi_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                      if</span><span class="w"> </span><span class="p">(</span><span class="n">NXputattr</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;long_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Polar Angle [degrees]&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">NXclosegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">             if</span><span class="w"> </span><span class="p">(</span><span class="n">NXclosegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="w">       </span><span class="c">!Open NXmonitor</span>
<span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;monitor1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;NXmonitor&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   call </span><span class="n">get_IPNS_item</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">sg</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)</span>
<span class="w">                   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;distance&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sg</span><span class="p">%</span><span class="n">L2</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop         </span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;moderator_distance&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">L1</span><span class="o">+</span><span class="n">sg</span><span class="p">%</span><span class="n">L2</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;time_of_flight&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sg</span><span class="p">%</span><span class="n">time_of_flight</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;microseconds&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                      if</span><span class="w"> </span><span class="p">(</span><span class="n">NXputattr</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;long_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Time-of-Flight [microseconds]&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sg</span><span class="p">%</span><span class="n">counts</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;counts&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                      if</span><span class="w"> </span><span class="p">(</span><span class="n">NXputattr</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;signal&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                      if</span><span class="w"> </span><span class="p">(</span><span class="n">NXputattr</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;long_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Monitor 1 Counts&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                      if</span><span class="w"> </span><span class="p">(</span><span class="n">NXputattr</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;axes&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;[time_of_flight]&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXgetgroupID</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="n">M1_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   call </span><span class="n">free_IPNS_subgroup</span><span class="w"> </span><span class="p">(</span><span class="n">sg</span><span class="p">)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXclosegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">             else</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">NXmakelink</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="n">M1_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">             end if</span>
<span class="w">       </span><span class="c">!Open NXmonitor</span>
<span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;monitor2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;NXmonitor&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   call </span><span class="n">get_IPNS_item</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">sg</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)</span>
<span class="w">                   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;distance&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sg</span><span class="p">%</span><span class="n">L2</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop         </span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;moderator_distance&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">L1</span><span class="o">+</span><span class="n">sg</span><span class="p">%</span><span class="n">L2</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;time_of_flight&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sg</span><span class="p">%</span><span class="n">time_of_flight</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;microseconds&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                      if</span><span class="w"> </span><span class="p">(</span><span class="n">NXputattr</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;long_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Time-of-Flight [microseconds]&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sg</span><span class="p">%</span><span class="n">counts</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;counts&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                      if</span><span class="w"> </span><span class="p">(</span><span class="n">NXputattr</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;signal&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                      if</span><span class="w"> </span><span class="p">(</span><span class="n">NXputattr</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;long_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Monitor 2 Counts&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                      if</span><span class="w"> </span><span class="p">(</span><span class="n">NXputattr</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;axes&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;[time_of_flight]&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXgetgroupID</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="n">M2_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">NXclosegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                call </span><span class="n">free_IPNS_subgroup</span><span class="w"> </span><span class="p">(</span><span class="n">sg</span><span class="p">)</span>
<span class="w">             </span><span class="k">else</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">NXmakelink</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="n">M2_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">             end if</span>
<span class="w">       </span><span class="c">!Open NXdata</span>
<span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;NXdata&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                call </span><span class="n">get_IPNS_item</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;TTL&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">char_value</span><span class="p">)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;title&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">char_value</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">NXUwritedata</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sgarray</span><span class="p">%</span><span class="n">counts</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;counts&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXputattr</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;signal&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXputattr</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;axes&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;[polar_angle,time_of_flight]&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">NXputattr</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;long_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Neutron Counts&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">NXmakelink</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="n">time_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">NXmakelink</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="n">phi_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">             if</span><span class="w"> </span><span class="p">(</span><span class="n">NXclosegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">NXclosegroup</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>
<span class="k">          call </span><span class="n">free_IPNS_sgarray</span><span class="w"> </span><span class="p">(</span><span class="n">sgarray</span><span class="p">)</span>
<span class="w">       </span><span class="k">end do</span>

<span class="k">       if</span><span class="w"> </span><span class="p">(</span><span class="n">NXclose</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NX_OK</span><span class="p">)</span><span class="w"> </span><span class="k">stop</span>

<span class="k">    contains</span>
<span class="k">       subroutine </span><span class="n">convert_time</span><span class="w"> </span><span class="p">(</span><span class="n">IPNS_time</span><span class="p">,</span><span class="w"> </span><span class="n">iso_time</span><span class="p">)</span>
<span class="w">       </span>
<span class="w">          </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">IPNS_time</span>
<span class="w">          </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">iso_time</span>
<span class="w">          </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">,</span><span class="w"> </span><span class="n">day</span>
<span class="w">          </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">months</span><span class="o">=</span><span class="s2">&quot;JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC&quot;</span>

<span class="w">          </span><span class="n">iso_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2000-01-01T01:01:00-0600&quot;</span>
<span class="w">          </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">IPNS_time</span><span class="p">(</span><span class="mi">8</span><span class="p">:</span><span class="mi">9</span><span class="p">),</span><span class="w"> </span><span class="n">fmt</span><span class="o">=*</span><span class="p">)</span><span class="w"> </span><span class="n">year</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">year</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">80</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">             </span><span class="n">iso_time</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;20&quot;</span><span class="o">//</span><span class="n">IPNS_time</span><span class="p">(</span><span class="mi">8</span><span class="p">:</span><span class="mi">9</span><span class="p">)</span>
<span class="w">          </span><span class="k">else</span>
<span class="k">             </span><span class="n">iso_time</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;19&quot;</span><span class="o">//</span><span class="n">IPNS_time</span><span class="p">(</span><span class="mi">8</span><span class="p">:</span><span class="mi">9</span><span class="p">)</span>
<span class="w">          </span><span class="k">end if</span>
<span class="k">          </span><span class="n">month</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nb">index</span><span class="p">(</span><span class="n">months</span><span class="p">,</span><span class="w"> </span><span class="n">IPNS_time</span><span class="p">(</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">month</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">             </span><span class="n">iso_time</span><span class="p">(</span><span class="mi">6</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0&quot;</span>
<span class="w">             </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="n">iso_time</span><span class="p">(</span><span class="mi">7</span><span class="p">:</span><span class="mi">7</span><span class="p">),</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;(i1)&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">month</span>
<span class="w">          </span><span class="k">else</span>
<span class="k">             write</span><span class="w"> </span><span class="p">(</span><span class="n">iso_time</span><span class="p">(</span><span class="mi">6</span><span class="p">:</span><span class="mi">7</span><span class="p">),</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;(i2)&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">month</span>
<span class="w">          </span><span class="k">end if         </span>
<span class="k">          read</span><span class="w"> </span><span class="p">(</span><span class="n">IPNS_time</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">fmt</span><span class="o">=*</span><span class="p">)</span><span class="w"> </span><span class="n">day</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">day</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">             </span><span class="n">iso_time</span><span class="p">(</span><span class="mi">9</span><span class="p">:</span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0&quot;</span>
<span class="w">             </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="n">iso_time</span><span class="p">(</span><span class="mi">10</span><span class="p">:</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;(i1)&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">day</span>
<span class="w">          </span><span class="k">else</span>
<span class="k">             write</span><span class="w"> </span><span class="p">(</span><span class="n">iso_time</span><span class="p">(</span><span class="mi">9</span><span class="p">:</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;(i2)&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">day</span>
<span class="w">          </span><span class="k">end if         </span>
<span class="k">          </span><span class="n">iso_time</span><span class="p">(</span><span class="mi">12</span><span class="p">:</span><span class="mi">19</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IPNS_time</span><span class="p">(</span><span class="mi">11</span><span class="p">:</span><span class="mi">18</span><span class="p">)</span>

<span class="w">       </span><span class="k">end subroutine </span><span class="n">convert_time</span>

<span class="w">    </span><span class="k">end program </span><span class="n">NXlrcs</span>
</pre></div>
</div>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <p>Have a Question? <a href="https://github.com/nexusformat/wiki/issues/new">Get help</a></p>
  </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><p>
 <a href="http://www.nexusformat.org/">
   <img src="https://raw.githubusercontent.com/nexusformat/NIAC/master/NeXus_Logo/NeXus_Logo_dark.svg" alt="NeXus"
        width="150"
        height="50"
   >
</a>
<br>NeXus is developed as an international standard by scientists and programmers representing major scientific
 facilities in Europe, Asia, Australia, and North America in order to facilitate greater cooperation in the
 analysis and visualization of neutron, x-ray, and muon data.
<br><a href="http://www.nexusformat.org/">Home</a>
<br><a href="https://github.com/nexusformat">GitHub Organisation</a>
<br>Â© 2025 <a href="http://www.nexusformat.org/NIAC.html">NIAC</a>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="NXmeasurement.html" title="NXmeasurement"
             >next</a></li>
        <li class="right" >
          <a href="NXgeometry_and_NXshape_-_documentation_and_review.html" title="NXgeometry and NXshape - documentation and review"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html"></a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">NXlrcs.f90</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2025, NIAC.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 9.1.0.
    </div>
  </body>
</html>